{{ template "head" . }}
<form method="post">
  <input type="hidden" name="_csrf" value="{{ .CSRFToken }}" />
  {{ if .Error }}
  <div class="alert alert-red">
    <h5 class="alert-title">Uh-oh!</h5>
    <p>{{.Error}}</p>
  </div>
  {{end}}

  <p>
    Hello! This is my QSL log. If you had a QSO with me, you should be able to
    find it below. Just make sure you find the timestamp of when we had the QSO so
    it can be matched with my logs.
  </p>

  <h2>Find Your QSO</h2>
  <p>Enter your call sign and the approximate time of our contact (UTC):</p>

  <div>
    <label for="callsign"><strong>Call Sign</strong></label>
    <br>
    <input
      type="text"
      name="callsign"
      id="callsign"
      class="wide"
      placeholder="e.g. A62A"
      style="text-transform: uppercase;"
      required
    />
  </div>

  <div>
    <label><strong>Date & Time (UTC)</strong></label>
    <br>
    <div class="datetime-inputs">
      <input
        type="number"
        name="year"
        id="year"
        placeholder="YYYY"
        min="2000"
        max="2100"
        maxlength="4"
        required
      />
      <span>-</span>
      <input
        type="number"
        name="month"
        id="month"
        placeholder="MM"
        min="1"
        max="12"
        maxlength="2"
        required
      />
      <span>-</span>
      <input
        type="number"
        name="day"
        id="day"
        placeholder="DD"
        min="1"
        max="31"
        maxlength="2"
        required
      />
      <span>&nbsp;&nbsp;</span>
      <input
        type="number"
        name="hour"
        id="hour"
        placeholder="HH"
        min="0"
        max="23"
        maxlength="2"
        required
      />
      <span>:</span>
      <input
        type="number"
        name="minute"
        id="minute"
        placeholder="MM"
        min="0"
        max="59"
        maxlength="2"
        required
      />
    </div>
    <br>
    <small>Enter the approximate time of our QSO (24-hour format). We'll search within ±10 minutes.</small>
  </div>

  <button type="submit" class="btn wide">Find QSO →</button>
</form>

<h3>Statistics</h3>
<p><strong>Total QSOs:</strong> {{ .TotalQSOs }} | <strong>Unique Countries:</strong> {{ .UniqueCountries }}</p>

{{ template "latest-qsos" . }}

<script>
document.addEventListener('DOMContentLoaded', function() {
  const inputs = ['year', 'month', 'day', 'hour', 'minute'];
  const maxLengths = [4, 2, 2, 2, 2];

  // Clear all inputs on page load
  const callsignInput = document.getElementById('callsign');
  if (callsignInput) callsignInput.value = '';
  inputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) input.value = '';
  });

  function safeSetCursorToEnd(input) {
    if (!input) return;
    const len = (input.value || '').toString().length;
    try {
      input.setSelectionRange(len, len);
    } catch (e) {
      // number inputs don't support setSelectionRange in some browsers – ignore
    }
  }

  // Find the first incomplete field, or last if all complete
  function findFocusField() {
    for (let i = 0; i < inputs.length; i++) {
      const input = document.getElementById(inputs[i]);
      if (!input) continue;
      if (!input.value || input.value.toString().length < maxLengths[i]) {
        return i;
      }
    }
    return inputs.length - 1;
  }

  // Focus on callsign field on page load
  setTimeout(() => {
    if (callsignInput) {
      callsignInput.focus();
    }
  }, 100);

  inputs.forEach((id, index) => {
    const input = document.getElementById(id);
    if (!input) return;

    input.addEventListener('input', function (e) {
      // Enforce max length manually (maxlength is ignored on type="number")
      if (this.value && this.value.toString().length > maxLengths[index]) {
        this.value = this.value.toString().slice(0, maxLengths[index]);
      }

      // Auto-move forward when field is filled, but not when deleting
      const isDelete =
        e.inputType && (e.inputType.startsWith('delete') || e.inputType === 'deleteContentBackward');
      if (
        !isDelete &&
        this.value &&
        this.value.toString().length >= maxLengths[index] &&
        index < inputs.length - 1
      ) {
        const nextInput = document.getElementById(inputs[index + 1]);
        if (nextInput) {
          nextInput.focus();
          safeSetCursorToEnd(nextInput);
        }
      }
    });

    input.addEventListener('keydown', function (e) {
      // Ignore common date/time delimiters and symbols in numeric fields
      const ignoredKeys = ['/', '-', ':', '.', ',', ' ', '_', '\\', '|', ';'];
      if (ignoredKeys.includes(e.key)) {
        e.preventDefault();
        return;
      }

      if (index === 0) return; // nothing before "year"

      const prevInput = document.getElementById(inputs[index - 1]);

      // DELETE: always jump to previous box
      if (e.key === 'Delete' && prevInput) {
        e.preventDefault();
        prevInput.focus();
        safeSetCursorToEnd(prevInput);
        return;
      }

      if (e.key === 'Backspace' && prevInput) {
        const valueStr = (this.value || '').toString();
        const atStart =
          this.selectionStart === 0 &&
          this.selectionEnd === 0;

        // If field is empty, go to previous field
        if (valueStr.length === 0) {
          e.preventDefault();
          prevInput.focus();
          safeSetCursorToEnd(prevInput);
          return;
        }

        // If caret is at start, go to previous field
        if (atStart) {
          e.preventDefault();
          prevInput.focus();
          safeSetCursorToEnd(prevInput);
        }
      }
    });
  });
});

</script>

{{ template "foot" . }}
